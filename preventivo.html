<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preventivo Stampa 3D - W OLE MILAN</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0; }
  header, footer { background:#005f73; color:white; padding:10px 20px; text-align:center; }
  main { padding:20px; max-width:600px; margin:auto; }
  #formPreventivo { background:white; padding:15px; border-radius:8px; box-shadow:0 0 8px rgba(0,0,0,0.1); }
  label { display:block; margin-top:15px; font-weight:bold; }
  select, input[type="number"], input[type="text"], input[type="email"], textarea, button {
    width:100%; padding:6px; margin-top:5px; box-sizing:border-box;
  }
  textarea { resize:vertical; min-height:60px; }
  .material-row { display:flex; align-items:center; gap:8px; }
  .material-select { flex:3; }
  .material-quantita { flex:1; }
  .custom-button {
    display:inline-block; padding:6px 12px; background:#0a9396; color:white;
    border:none; border-radius:5px; cursor:pointer; font-size:16px; margin-top:5px;
    width:100%;
  }
  .custom-button:hover { background:#007f7f; }
  #fileNameDisplay { margin-top:5px; font-style:italic; color:#333; }
  #risultato { margin-top:20px; background:#e9ecef; padding:10px; border-radius:5px; min-height:40px; }
  #emailStatus { margin-top:10px; font-weight:bold; color:red; }
</style>
</head>
<body>

<header>
  <h1>Preventivo Stampa 3D - W OLE INTER</h1>
</header>

<main>
<section id="formPreventivo">
  <form id="preventivoForm" onsubmit="return false;">

    <label>Materiale e percentuale(%):</label>
    <div class="material-row">
      <select name="materiale" class="material-select">
        <option value="PLA">PLA (€20/kg)</option>
        <option value="ABS">ABS (€25/kg)</option>
        <option value="PETG">PETG (€22/kg)</option>
        <option value="TPU">TPU (€30/kg)</option>
      </select>
      <input type="number" min="1" max="100" value="100" class="material-quantita"> <span>%</span>
    </div>

    <label for="ugello">Ugello:</label>
    <select id="ugello" name="ugello">
      <option value="0.2">0.2 mm</option>
      <option value="0.4" selected>0.4 mm</option>
      <option value="0.6">0.6 mm</option>
      <option value="0.8">0.8 mm</option>
    </select>

    <label for="velocita">Velocità:</label>
    <select id="velocita" name="velocita">
      <option value="0.5">50%</option>
      <option value="1" selected>100%</option>
      <option value="1.24">124%</option>
      <option value="1.6">160%</option>
    </select>

    <label for="quantita">Quantità (copie):</label>
    <input type="number" id="quantita" value="1" min="1">

    <label for="projectNote">Nota:</label>
    <textarea id="projectNote" placeholder="Aggiungi una nota..."></textarea>

    <label>Caricamento progetto:</label>
    <input type="file" id="file3d" accept=".stl" style="display:none;">
    <button type="button" class="custom-button" id="btnCaricaFile">Scegli File STL</button>
    <div id="fileNameDisplay">Nessun file selezionato</div>

    <label for="projectLink">Oppure link progetto Makerworld:</label>
    <input type="text" id="projectLink" placeholder="Inserisci il link del progetto...">

    <label for="nomeCliente">Nome Cliente:</label>
    <input type="text" id="nomeCliente" placeholder="Inserisci il tuo nome">

    <label for="emailCliente">Email</label>
    <input type="email" id="emailCliente" placeholder="Inserire la propria email...">

    <button id="sendFileBtn" type="button" class="custom-button">Invia Preventivo</button>
    <div id="emailStatus"></div>
  </form>
</section>
</main>

<footer>
  <h1>Progetti Multimateriale e Multicolore</h1>
</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDxtlixYrN6bP8l82n7qXdvuEzAH6iUvEo",
    authDomain: "ianlab-3dservices.firebaseapp.com",
    projectId: "ianlab-3dservices",
    storageBucket: "ianlab-3dservices.firebasestorage.app",
    messagingSenderId: "635234682907",
    appId: "1:635234682907:web:af7ed7e76755d1ec71d0be"
  };
  firebase.initializeApp(firebaseConfig);
  const storage = firebase.storage();

  const fileInput = document.getElementById("file3d");
  const btnCaricaFile = document.getElementById("btnCaricaFile");
  const fileNameDisplay = document.getElementById("fileNameDisplay");

  btnCaricaFile.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", () => {
    if(fileInput.files.length > 0){
      fileNameDisplay.innerText = fileInput.files[0].name;
    } else {
      fileNameDisplay.innerText = "Nessun file selezionato";
    }
  });

  document.getElementById("sendFileBtn").addEventListener("click", async () => {
    const emailStatus = document.getElementById("emailStatus");
    emailStatus.innerText = "";

    const nomeCliente = document.getElementById("nomeCliente").value.trim();
    const emailCliente = document.getElementById("emailCliente").value.trim();
    const materiale = document.querySelector(".material-select").value;
    const ugello = document.getElementById("ugello").value;
    const velocita = document.getElementById("velocita").value;
    const projectQuantity = document.getElementById("quantita").value;
    const projectNote = document.getElementById("projectNote").value.trim();
    const projectLink = document.getElementById("projectLink").value.trim();
    const file = fileInput.files[0];

    if (!emailCliente || !nomeCliente) {
      emailStatus.innerText = "Nome e email sono obbligatori.";
      return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if(!emailRegex.test(emailCliente)){
      emailStatus.innerText = "Formato email non valido.";
      return;
    }

    let fileUrl = "";
    if(file){
      const storageRef = storage.ref('uploads/' + file.name);
      const uploadTask = storageRef.put(file);

      await new Promise((resolve, reject) => {
        uploadTask.on('state_changed', 
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            emailStatus.innerText = "Caricamento in corso: " + progress.toFixed(0) + "%";
          },
          (error) => { 
            emailStatus.innerText = "Errore caricamento file: " + error;
            reject(error);
          },
          async () => {
            fileUrl = await storageRef.getDownloadURL();
            emailStatus.innerText = "File caricato con successo!";
            resolve();
          }
        );
      });
    }

    // Chiamata alla Firebase Function
    try {
      const response = await fetch("https://us-central1-ianlab-3dservices.cloudfunctions.net/sendPreventivoEmail", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          nomeCliente,
          emailCliente,
          materiale,
          ugello,
          velocita,
          projectQuantity,
          projectNote,
          projectLink,
          fileUrl
        })
      });
      const result = await response.json();
      if(result.success){
        emailStatus.style.color = "green";
        emailStatus.innerText = "Preventivo inviato con successo!";
      } else {
        emailStatus.style.color = "red";
        emailStatus.innerText = "Errore invio preventivo: " + result.error;
      }
    } catch(err){
      emailStatus.style.color = "red";
      emailStatus.innerText = "Errore invio preventivo: " + err;
    }
  });
</script>

</body>
</html>
