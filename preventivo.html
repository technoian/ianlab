<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Preventivo Stampa 3D STL</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0; padding: 20px;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 800px;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 0 12px #ccc;
      width: 100%;
    }
    label {
      font-weight: bold;
      margin-top: 15px;
      display: block;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
    }
    #colori-container input[type="color"] {
      width: 50px;
      height: 40px;
      margin-right: 10px;
      border: none;
      cursor: pointer;
      display: inline-block;
      vertical-align: middle;
    }
    button {
      background-color: #007acc;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      margin-top: 20px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #005f99;
    }
    #output {
      margin-top: 20px;
      background: #e0ffe0;
      border: 1px solid #4CAF50;
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      display: none;
    }
    #viewer3d {
      width: 100%;
      height: 320px;
      background: #ddd;
      margin-top: 25px;
      border-radius: 12px;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Preventivo Stampa 3D STL</h1>

    <label>Nome progetto</label>
    <input type="text" id="nomeProgetto" placeholder="Es. Porta chiavi multicolore" />

    <label>Carica file STL</label>
    <input type="file" id="file3d" accept=".stl" />

    <label>Materiale</label>
    <input type="text" id="materiale" placeholder="Es. PLA, PETG, TPU..." />

    <label>Ugello (mm)</label>
    <input type="number" id="ugello" value="0.4" step="0.1" min="0.1" max="1.0" />

    <label>Velocit√† di stampa</label>
    <select id="velocita">
      <option value="50">üê¢ 50% (precisa)</option>
      <option value="100" selected>üö∂ 100% (normale)</option>
      <option value="124">üèÉ 124% (veloce)</option>
      <option value="160">üöÄ 160% (turbo)</option>
    </select>

    <label>Riempimento (%)</label>
    <input type="number" id="infill" value="20" min="0" max="100" />

    <label>Colori</label>
    <div id="colori-container">
      <input type="color" name="colori" value="#ff0000" />
    </div>
    <button type="button" onclick="aggiungiColore()">‚ûï Aggiungi un colore</button>

    <label>Note extra</label>
    <textarea id="note" rows="3" placeholder="Es. Supporti, superficie liscia..."></textarea>

    <button onclick="calcolaPreventivo()">üì¶ Calcola preventivo</button>

    <div id="output"></div>

    <div id="viewer3d"></div>
  </div>

  <!-- Three.js e loader STL -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/STLLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js"></script>

  <script>
    // Gestione colori multipli
    function aggiungiColore() {
      const container = document.getElementById('colori-container');
      const input = document.createElement('input');
      input.type = 'color';
      input.name = 'colori';
      input.value = '#ffffff';
      container.appendChild(input);
    }

    // Setup three.js per visualizzare STL
    let scene, camera, renderer, controls;
    let mesh;

    function init3DViewer() {
      const container = document.getElementById('viewer3d');
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xeeeeee);

      camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
      camera.position.set(0, 0, 100);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.innerHTML = ''; // pulisce eventuali render precedenti
      container.appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.1;
      controls.minDistance = 10;
      controls.maxDistance = 500;

      // Luce
      const ambientLight = new THREE.AmbientLight(0x404040, 2);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(0, 1, 1);
      scene.add(directionalLight);

      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    // Caricamento STL
    document.getElementById('file3d').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.name.toLowerCase().endsWith('.stl')) {
        alert('Carica solo file STL.');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const contents = e.target.result;

        if (mesh) {
          scene.remove(mesh);
          mesh.geometry.dispose();
          mesh.material.dispose();
          mesh = null;
        }

        const loader = new THREE.STLLoader();
        const geometry = loader.parse(contents);

        // Materiale semplice con colore grigio
        const material = new THREE.MeshPhongMaterial({ color: 0x999999, specular: 0x111111, shininess: 200 });
        mesh = new THREE.Mesh(geometry, material);

        // Centra il modello
        geometry.computeBoundingBox();
        const center = new THREE.Vector3();
        geometry.boundingBox.getCenter(center);
        mesh.position.sub(center);

        scene.add(mesh);

        // Zoom per adattare modello
        const size = geometry.boundingBox.getSize(new THREE.Vector3()).length();
        const distance = size * 1.5;
        camera.position.set(distance, distance, distance);
        controls.update();
      };
      reader.readAsArrayBuffer(file);
    });

    // Calcolo preventivo (funzione demo)
    function calcolaPreventivo() {
      const nome = document.getElementById('nomeProgetto').value.trim();
      const materiale = document.getElementById('materiale').value.trim();
      const ugello = parseFloat(document.getElementById('ugello').value);
      const velocita = parseInt(document.getElementById('velocita').value);
      const infill = parseInt(document.getElementById('infill').value);
      const note = document.getElementById('note').value.trim();

      const coloriInputs = document.querySelectorAll('#colori-container input[type="color"]');
      const colori = Array.from(coloriInputs).map(i => i.value);

      if (!nome) {
        alert('Inserisci il nome del progetto.');
        return;
      }
      if (!materiale) {
        alert('Inserisci il materiale.');
        return;
      }
      if (!mesh) {
        alert('Carica un file STL prima di calcolare il preventivo.');
        return;
      }

      // Simuliamo il volume del modello come volume bounding box * 0.6 (approssimazione)
      const bbox = mesh.geometry.boundingBox;
      const volBBox = (bbox.max.x - bbox.min.x) * (bbox.max.y - bbox.min.y) * (bbox.max.z - bbox.min.z);
      const volumeStima = volBBox * 0.6; // in cm¬≥ ipotetici

      // Prezzo materiale al cm¬≥ (demo)
      let prezzoMateriale;
      switch(materiale.toLowerCase()) {
        case 'pla': prezzoMateriale = 0.05; break;
        case 'petg': prezzoMateriale = 0.06; break;
        case 'tpu': prezzoMateriale = 0.07; break;
        default: prezzoMateriale = 0.05;
      }

      // Calcolo prezzo base
      let prezzoBase = volumeStima * prezzoMateriale;

      // Modifica in base all'ugello (pi√π piccolo = stampa pi√π lenta e costosa)
      prezzoBase *= (0.4 / ugello);

      // Modifica in base alla velocit√† (pi√π veloce = meno costo)
      prezzoBase *= (100 / velocita);

      // Modifica in base al riempimento
      prezzoBase *= (infill / 20); // 20% √® base

      // Prezzo aggiuntivo per colori multipli
      if (colori.length > 1) {
        prezzoBase *= (1 + 0.05 * (colori.length - 1)); // +5% ogni colore aggiuntivo
      }

      prezzoBase = Math.max(prezzoBase, 0.5); // prezzo minimo

      // Mostra preventivo
      const out = `
Nome progetto: ${nome}
Materiale: ${materiale}
Ugello: ${ugello} mm
Velocit√†: ${velocita}%
Riempimento: ${infill}%
Colori usati: ${colori.length} (${colori.join(', ')})
Volume stimato modello: ${volumeStima.toFixed(2)} cm¬≥
Note extra: ${note || 'Nessuna'}

Prezzo stimato: ‚Ç¨ ${prezzoBase.toFixed(2)}
      `;

      const outputDiv = document.getElementById('output');
      outputDiv.textContent = out;
      outputDiv.style.display = 'block';
    }

    window.addEventListener('load', init3DViewer);
  </script>
</body>
</html>
