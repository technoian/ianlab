<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Preventivo Stampa 3D Multimateriale - IanLab</title>
<style>
  body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 20px; }
  h1 { text-align: center; }
  #viewer {
    width: 500px; height: 500px; margin: 20px auto;
    border: 2px dashed #999; background: #ddd;
    display: flex; align-items: center; justify-content: center;
    color: #666; user-select: none;
  }
  #viewer.dragover { border-color: #333; background: #bbb; color: #000; }
  #controls {
    max-width: 700px; margin: 0 auto;
    background: #fff; padding: 20px; border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  label { font-weight: bold; margin-top: 10px; display: block; }
  select, input[type=number], button {
    width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box;
    font-size: 1rem; border: 1px solid #aaa; border-radius: 5px;
  }
  .material-row {
    margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 6px;
    display: flex; align-items: center; gap: 10px;
  }
  .material-row > * {
    flex: 1 1 120px;
  }
  .material-row .check-container {
    flex: 0 0 25px;
    display: flex; justify-content: center; align-items: center;
  }
  .material-row label {
    margin: 0; font-weight: normal;
  }
  .small-input {
    max-width: 80px;
  }
  #result {
    max-width: 700px; margin: 20px auto;
    background: #e6ffe6; border: 1px solid #33aa33;
    padding: 15px; border-radius: 6px; font-weight: bold;
    font-size: 1.1rem; display: none;
  }
  #error {
    max-width: 700px; margin: 20px auto;
    background: #ffe6e6; border: 1px solid #aa3333;
    padding: 15px; border-radius: 6px; font-weight: bold;
    font-size: 1.1rem; color: #aa0000; display: none;
  }
</style>
</head>
<body>

<h1>Preventivo Stampa 3D Multimateriale - IanLab</h1>

<div id="viewer">Trascina qui il file STL o clicca "Carica file STL"</div>

<div id="controls">
  <button id="btn-upload">Carica file STL</button>
  <input type="file" id="file-input" accept=".stl" style="display:none" />

  <label>Materiali (seleziona e imposta percentuale):</label>
  <div id="materials-container"></div>

  <button id="btn-calc" style="margin-top:15px;">Calcola Preventivo</button>
</div>

<div id="error"></div>
<div id="result"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/examples/js/loaders/STLLoader.js"></script>

<script>
  // Materiali disponibili e prezzo €/grammo
  const materiali = [
    { name: "PLA", available: true, price: 0.02 },
    { name: "PLA+ / Tough PLA", available: false, price: 0.025 },
    { name: "PLA Silk / Wood / Marble / Metal", available: false, price: 0.03 },
    { name: "PETG", available: false, price: 0.03 },
    { name: "PETG-CF", available: true, price: 0.04 },
    { name: "TPU 95A", available: true, price: 0.04 },
    { name: "ABS", available: false, price: 0.025 },
    { name: "ASA", available: false, price: 0.035 },
    { name: "PA (Nylon)", available: false, price: 0.05 },
    { name: "PA-CF / PA-GF", available: false, price: 0.055 },
    { name: "PC / PC-Blend", available: false, price: 0.07 },
    { name: "PVA", available: false, price: 0.06 },
    { name: "BVOH", available: false, price: 0.06 }
  ];

  // Ugelli disponibili in mm
  const ugelli = [0.4, 0.6, 0.8];
  // Velocità disponibili in mm/s
  const velocitaPossibili = [20,30,40,50,60,70,80,90,100];

  const containerMat = document.getElementById('materials-container');
  const viewer = document.getElementById('viewer');
  const btnUpload = document.getElementById('btn-upload');
  const fileInput = document.getElementById('file-input');
  const btnCalc = document.getElementById('btn-calc');
  const resultDiv = document.getElementById('result');
  const errorDiv = document.getElementById('error');

  let scene, camera, renderer, controls;
  let currentObject = null;
  let pesoStimato = 0;

  // Funzione per creare la riga di materiale con checkbox, % input, ugello e velocità
  function creaRigaMateriale(idx, mat) {
    const div = document.createElement('div');
    div.className = 'material-row';

    const cbDiv = document.createElement('div');
    cbDiv.className = 'check-container';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = `mat-cb-${idx}`;
    cb.disabled = !mat.available;
    cb.checked = false;
    cbDiv.appendChild(cb);

    const label = document.createElement('label');
    label.htmlFor = `mat-cb-${idx}`;
    label.textContent = mat.name + (mat.available ? '' : ' (non disponibile)');
    if (!mat.available) label.style.color = '#999';

    const percInput = document.createElement('input');
    percInput.type = 'number';
    percInput.min = 0; percInput.max = 100;
    percInput.value = 0;
    percInput.className = 'small-input';
    percInput.disabled = true;
    percInput.title = 'Percentuale di utilizzo materiale (%)';

    const selNozzle = document.createElement('select');
    ugelli.forEach(u => {
      const o = document.createElement('option');
      o.value = u;
      o.textContent = u + ' mm';
      selNozzle.appendChild(o);
    });
    selNozzle.disabled = true;

    const selSpeed = document.createElement('select');
    velocitaPossibili.forEach(v => {
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v + ' mm/s';
      selSpeed.appendChild(o);
    });
    selSpeed.disabled = true;

    cb.addEventListener('change', () => {
      percInput.disabled = !cb.checked;
      selNozzle.disabled = !cb.checked;
      selSpeed.disabled = !cb.checked;
      if (!cb.checked) percInput.value = 0;
    });

    div.appendChild(cbDiv);
    div.appendChild(label);
    div.appendChild(percInput);
    div.appendChild(selNozzle);
    div.appendChild(selSpeed);

    return div;
  }

  // Popola materiali
  function popolaMateriali() {
    containerMat.innerHTML = '';
    materiali.forEach((m,i) => {
      const r = creaRigaMateriale(i,m);
      containerMat.appendChild(r);
    });
  }

  // Inizializza Three.js
  function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(45, 500 / 500, 0.1, 1000);
    camera.position.set(0, 0, 100);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(500, 500);
    viewer.innerHTML = '';
    viewer.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
    light1.position.set(1,1,1);
    scene.add(light1);
    const light2 = new THREE.AmbientLight(0x404040);
    scene.add(light2);

    animate();
  }

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }

  // Carica STL e aggiunge alla scena
  function caricaSTL(file) {
    errorDiv.style.display = 'none';
    resultDiv.style.display = 'none';
    const reader = new FileReader();
    reader.onload = function(e) {
      const contents = e.target.result;
      try {
        const loader = new THREE.STLLoader();
        if(currentObject) {
          scene.remove(currentObject);
          currentObject.geometry.dispose();
          currentObject.material.dispose();
          currentObject = null;
        }
        const geometry = loader.parse(contents);
        const material = new THREE.MeshPhongMaterial({ color: 0x888888, specular: 0x111111, shininess: 200 });
        currentObject = new THREE.Mesh(geometry, material);

        geometry.computeBoundingBox();
        const bbox = geometry.boundingBox;
        // Calcolo volume approssimativo
        const size = new THREE.Vector3();
        bbox.getSize(size);
        // Stima peso in grammi:
        // PLA densità circa 1.24 g/cm3
        // volume in mm3 -> cm3 = mm3/1000
        // peso = volume* densità
        // STL da mesh chiusa -> volume stimato usando bounding box (approx)
        const volume_mm3 = size.x * size.y * size.z; 
        pesoStimato = volume_mm3 / 1000 * 1.24; // grammi

        scene.add(currentObject);

        // Posiziona e scala
        const maxDim = Math.max(size.x, size.y, size.z);
        const scale = 80 / maxDim;
        currentObject.scale.set(scale, scale, scale);

        currentObject.position.set(0, 0, 0);
        controls.target.set(0,0,0);
        controls.update();

        viewer.style.color = '#000';
        viewer.textContent = '';

      } catch(err) {
        showError('Errore nel caricamento STL: ' + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  // Errori e risultati
  function showError(msg) {
    errorDiv.style.display = 'block';
    errorDiv.textContent = msg;
    resultDiv.style.display = 'none';
  }

  function showResult(msg) {
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = msg;
    errorDiv.style.display = 'none';
  }

  // Calcolo preventivo
  function calcolaPreventivo() {
    if (!currentObject) {
      showError("Carica prima un file STL valido.");
      return;
    }
    // Raccogli dati selezionati
    const righe = containerMat.querySelectorAll('.material-row');
    let totalePerc = 0;
    let materialiSelezionati = [];

    for (let r of righe) {
      const cb = r.querySelector('input[type=checkbox]');
      if (!cb.checked) continue;

      const perc = parseFloat(r.querySelector('input[type=number]').value);
      if (isNaN(perc) || perc <= 0) {
        showError("Inserisci percentuali valide e maggiori di zero.");
        return;
      }
      totalePerc += perc;

      const ugello = r.querySelector('select:nth-of-type(1)').value;
      const velocita = r.querySelector('select:nth-of-type(2)').value;
      const nomeMat = r.querySelector('label').textContent.replace(' (non disponibile)', '');

      materialiSelezionati.push({
        nome: nomeMat,
        percentuale: perc,
        ugello: ugello,
        velocita: velocita,
        prezzo: materiali.find(m => m.name === nomeMat).price
      });
    }

    if (totalePerc === 0) {
      showError("Seleziona almeno un materiale e inserisci la percentuale.");
      return;
    }
    if (Math.round(totalePerc) !== 100) {
      showError("La somma delle percentuali deve essere 100%. Attualmente è " + totalePerc.toFixed(2) + "%.");
      return;
    }

    // Calcolo costo
    let costoTotale = 0;
    let dettagli = "<ul>";
    materialiSelezionati.forEach(m => {
      const pesoMat = pesoStimato * (m.percentuale / 100);
      const costoMat = pesoMat * m.prezzo;
      costoTotale += costoMat;

      dettagli += `<li><b>${m.nome}</b>: ${pesoMat.toFixed(1)} g × €${m.prezzo.toFixed(3)} = €${costoMat.toFixed(2)} (Ugello: ${m.ugello} mm, Velocità: ${m.velocita} mm/s)</li>`;
    });
    dettagli += "</ul>";

    showResult(`Peso stimato: <b>${pesoStimato.toFixed(1)} g</b><br>
               Costo stimato: <b>€${costoTot
