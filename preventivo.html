<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Preventivo Stampa 3D Multimateriale - IanLab</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
  h1 { text-align: center; margin-bottom: 20px; }
  #viewer {
    width: 500px; height: 500px;
    margin: 0 auto 20px auto;
    background: #ddd;
    border: 2px dashed #aaa;
    display: flex; align-items: center; justify-content: center;
    color: #444;
    user-select: none;
    position: relative;
  }
  #viewer.dragover { border-color: #333; background: #ccc; color: #000; }
  #controls {
    max-width: 600px; margin: 0 auto 20px auto;
    background: white; padding: 20px; border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }
  label {
    font-weight: bold; margin-top: 10px; display: block;
  }
  select, input[type=number], button {
    width: 100%; padding: 6px; margin-top: 5px; box-sizing: border-box;
    font-size: 1rem;
    border: 1px solid #aaa;
    border-radius: 4px;
  }
  .material-row {
    border: 1px solid #ccc;
    padding: 10px 12px;
    margin-top: 10px;
    border-radius: 6px;
    background: #f9f9f9;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
  }
  .material-row > * {
    flex: 1 1 120px;
  }
  .material-checkbox {
    flex: 0 0 30px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .material-label {
    flex: 2 1 140px;
    font-weight: bold;
  }
  .small-input {
    max-width: 80px;
  }
  #result {
    max-width: 600px; margin: 20px auto;
    background: #e7f7e7;
    border: 1px solid #6c9f6c;
    color: #2e7d32;
    padding: 15px;
    border-radius: 6px;
    font-weight: bold;
    font-size: 1.1rem;
    display: none;
  }
</style>
</head>
<body>

<h1>Preventivo Stampa 3D Multimateriale - IanLab</h1>

<div id="viewer">Trascina qui il file STL o usa il pulsante sotto per caricarlo.</div>

<div id="controls">
  <button id="btn-upload">Carica file STL</button>
  <input type="file" id="file-input" accept=".stl" style="display:none" />

  <label>Materiali (scegli e imposta percentuale)</label>
  <div id="materials-container"></div>

  <button id="btn-calc" style="margin-top:15px;">Calcola Preventivo</button>
</div>

<div id="result"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/examples/js/loaders/STLLoader.js"></script>

<script>
  // Lista materiali base con disponibilità e prezzo €/grammo
  const materiali = [
    { name: "PLA", available: true, price: 0.02 },
    { name: "PLA+ / Tough PLA", available: false, price: 0.025 },
    { name: "PLA Silk / Wood / Marble / Metal", available: false, price: 0.03 },
    { name: "PETG", available: false, price: 0.03 },
    { name: "PETG-CF", available: true, price: 0.04 },
    { name: "TPU 95A", available: true, price: 0.04 },
    { name: "ABS", available: false, price: 0.025 },
    { name: "ASA", available: false, price: 0.035 },
    { name: "PA (Nylon)", available: false, price: 0.05 },
    { name: "PA-CF / PA-GF", available: false, price: 0.055 },
    { name: "PC / PC-Blend", available: false, price: 0.07 },
    { name: "PVA", available: false, price: 0.06 },
    { name: "BVOH", available: false, price: 0.06 }
  ];

  // Opzioni ugelli
  const ugelli = [0.4, 0.6, 0.8];
  // Opzioni velocità base (mm/s)
  const velocitaPossibili = [20, 30, 40, 50, 60, 70, 80, 90, 100];

  // Container materiali
  const containerMat = document.getElementById('materials-container');

  // Inizializza array dati materiali selezionati
  let materialiSelezionati = [];

  // Funzione per creare riga materiale con checkbox, input %, ugello e velocità
  function creaRigaMateriale(idx, mat) {
    const div = document.createElement('div');
    div.className = 'material-row';

    const cbDiv = document.createElement('div');
    cbDiv.className = 'material-checkbox';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = `mat-cb-${idx}`;
    cb.disabled = !mat.available;
    cb.checked = mat.available ? false : false;
    cbDiv.appendChild(cb);

    const label = document.createElement('label');
    label.htmlFor = `mat-cb-${idx}`;
    label.className = 'material-label';
    label.textContent = mat.name + (mat.available ? '' : ' (non disponibile)');
    if (!mat.available) label.style.color = '#999';

    const percInput = document.createElement('input');
    percInput.type = 'number';
    percInput.min = 0;
    percInput.max = 100;
    percInput.value = 0;
    percInput.className = 'small-input';
    percInput.disabled = true;
    percInput.title = 'Percentuale di utilizzo materiale (%)';

    const selNozzle = document.createElement('select');
    ugelli.forEach(u => {
      const o = document.createElement('option');
      o.value = u;
      o.textContent = u + ' mm';
      selNozzle.appendChild(o);
    });
    selNozzle.disabled = true;

    const selSpeed = document.createElement('select');
    velocitaPossibili.forEach(v => {
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v + ' mm/s';
      selSpeed.appendChild(o);
    });
    selSpeed.disabled = true;

    // Abilita/disabilita inputs se checkbox checked
    cb.addEventListener('change', () => {
      percInput.disabled = !cb.checked;
      selNozzle.disabled = !cb.checked;
      selSpeed.disabled = !cb.checked;
      if (!cb.checked) percInput.value = 0;
    });

    // Metti dentro la riga
    div.appendChild(cbDiv);
    div.appendChild(label);

    // Percentuale
    const percWrapper = document.createElement('div');
    percWrapper.style.flex = "0 0 100px";
    percWrapper.appendChild(percInput);
    div.appendChild(percWrapper);

    // Ugello
    const nozzWrapper = document.createElement('div');
    nozzWrapper.style.flex = "0 0 100px";
    nozzWrapper.appendChild(selNozzle);
    div.appendChild(nozzWrapper);

    // Velocità
    const speedWrapper = document.createElement('div');
    speedWrapper.style.flex = "0 0 100px";
    speedWrapper.appendChild(selSpeed);
    div.appendChild(speedWrapper);

    return div;
  }

  // Popola materiali nell'interfaccia
  function popolaMateriali() {
    containerMat.innerHTML = '';
    materiali.forEach((m, i) => {
      const riga = creaRigaMateriale(i, m);
      containerMat.appendChild(riga);
    });
  }

  // Three.js setup per visualizzare STL
  let scene, camera, renderer, controls;
  let currentObject = null;
  let pesoStimato = 0;

  function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(60, 1, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(500, 500);
    const viewer = document.getElementById('viewer');
    viewer.innerHTML = '';
    viewer.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    camera.position.set(0, 0, 100);
    controls.update();

    scene.add(new THREE.AmbientLight(0x404040));
    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(1, 1, 1).normalize();
    scene.add(dirLight);

    animate();
  }
  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }

  function clearScene() {
    if (currentObject) {
      scene.remove(currentObject);
      currentObject.traverse(child => {
        if (child.isMesh) {
          child.geometry.dispose();
          child.material.dispose();
        }
      });
      currentObject = null;
      pesoStimato = 0;
      document.getElementById('result').style.display = 'none';
      document.getElementById('result').innerHTML = '';
      document.getElementById('viewer').textContent = 'Trascina qui il file STL o usa il pulsante sotto per caricarlo.';
    }
  }

  function updateInfo(object) {
    const box = new THREE.Box3().setFromObject(object);
    const size = new THREE.Vector3();
    box.getSize(size);

    // Volume stimato in mm3
    const volumeMm3 = size.x * size.y * size.z;

    // Peso stimato (g) con densità PLA 1.25g/cm3
    // Per ora peso stimato senza riempimento per info
    pesoStimato = (volumeMm3 / 1000) * 1.25;

    // Adatta camera
    const maxDim = Math.max(size.x, size.y, size.z);
    const fov = camera.fov * Math.PI / 180;
    let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
    cameraZ *= 1.5;
    camera.position.set(0, 0, cameraZ);
    const center = box.getCenter(new THREE.Vector3());
    controls.target.copy(center);
    controls.update();
  }

  function loadFile(file) {
    clearScene();
    if (!file.name.toLowerCase().
