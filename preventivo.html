<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Preventivo Stampa 3D (-) Solo Calcolo - W OLE MILAN</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f0f0; }
    header, footer { background: #005f73; color: white; padding: 10px 20px; text-align: center; }
    main { padding: 20px; max-width: 600px; margin: auto; }
    #formPreventivo { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 15px; font-weight: bold; }
    select, input[type="number"], input[type="text"], input[type="email"], textarea {
      width: 100%; padding: 6px; margin-top: 5px; box-sizing: border-box;
    }
    textarea { resize: vertical; min-height: 60px; }
    button { margin-top: 20px; padding: 10px; width: 100%; background: #0a9396; border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 5px; }
    button:hover { background: #007f7f; }
    .custom-file-button { display: inline-block; padding: 6px 12px; background: #0a9396; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 5px; width: auto; }
    .custom-file-button:hover { background: #007f7f; }
    #risultato { margin-top: 20px; background: #e9ecef; padding: 10px; border-radius: 5px; min-height: 40px; }
    .material-row { display: flex; align-items: center; gap: 8px; }
    .material-select { flex: 3; }
    .material-quantita { flex: 1; }
    #emailStatus { margin-top:10px; font-weight:bold; color: green; }
    #debugMessage { margin-top: 10px; color: red; font-weight: bold; }
  </style>
</head>
<body>

<header>
  <h1>Preventivo Stampa 3D (-) Solo Calcolo - W OLE INTER</h1>
</header>

<main>
  <section id="formPreventivo">
    <form id="preventivoForm" onsubmit="return false;">
      <label>Materiale e percentuale(%):</label>
      <div class="material-row">
        <select name="materiale" class="material-select">
          <option value="PLA">PLA (€20/kg)</option>
          <option value="ABS">ABS (€25/kg)</option>
          <option value="PETG">PETG (€22/kg)</option>
          <option value="TPU">TPU (€30/kg)</option>
        </select>
        <input type="number" min="1" max="100" value="100" class="material-quantita" /> <span>%</span>
      </div>

      <label for="ugello">Ugello:</label>
      <select id="ugello" name="ugello">
        <option value="0.2">0.2 mm</option>
        <option value="0.4" selected>0.4 mm</option>
        <option value="0.6">0.6 mm</option>
        <option value="0.8">0.8 mm</option>
      </select>

      <label for="velocita">Velocità:</label>
      <select id="velocita" name="velocita">
        <option value="0.5">50%</option>
        <option value="1" selected>100%</option>
        <option value="1.24">124%</option>
        <option value="1.6">160%</option>
      </select>

      <label for="quantita">Quantità (copie):</label>
      <input type="number" id="quantita" value="1" min="1" />

      <label for="projectNote">Nota:</label>
      <textarea id="projectNote" placeholder="Aggiungi una nota..."></textarea>

      <label>Caricamento progetto:</label>
      <p>Inserisci <strong>uno solo</strong> tra i due campi seguenti:</p>
      <input type="file" id="file3d" accept=".stl" style="display:none;" />
      <button type="button" class="custom-file-button" onclick="document.getElementById('file3d').click()">Carica File STL</button>

      <label for="projectLink">Oppure link progetto Makerworld:</label>
      <input type="text" id="projectLink" placeholder="Inserisci il link del progetto..." />

      <button id="btnCalcola">Calcola preventivo</button>

      <div id="risultato">Risultato preventivo: <span id="outputPrezzo">-</span></div>

      <label for="emailCliente">Email</label>
      <input type="email" id="emailCliente" placeholder="Inserire la propria email..." />

      <button id="sendEmailBtn" type="button">Invia dettagli via email</button>
      <div id="emailStatus"></div>
      <div id="debugMessage"></div>
    </form>
  </section>
</main>

<footer>
  <h1>Progetti Multimateriale e Multicolore</h1>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  emailjs.init("avx0UIyZCDX-4MASY");

  const fileInput = document.getElementById("file3d");
  const debugMsg = document.getElementById("debugMessage");
  const emailStatus = document.getElementById("emailStatus");

  fileInput.addEventListener("change", () => {
    if (fileInput.files.length > 0) {
      debugMsg.innerText = "File selezionato: " + fileInput.files[0].name;
    } else {
      debugMsg.innerText = "Nessun file selezionato";
    }
  });

  document.getElementById("sendEmailBtn").addEventListener("click", async () => {
    emailStatus.innerText = "Invio email in corso...";
    const materiale = document.querySelector(".material-select").value;
    const ugello = document.getElementById("ugello").value;
    const velocita = document.getElementById("velocita").value;
    const quantita = document.getElementById("quantita").value;
    const projectNote = document.getElementById("projectNote").value;
    const projectLink = document.getElementById("projectLink").value;
    const emailCliente = document.getElementById("emailCliente").value || "no_email@no_reply.com";
    const nomeCliente = emailCliente.split("@")[0];
    const file3d = fileInput.files[0];

    const templateParams = {
      materiale,
      ugello,
      velocita,
      projectQuantity: quantita,
      projectNote,
      projectLink,
      nomeCliente,
      from_email: emailCliente
    };

    if (file3d) {
      try {
        const reader = new FileReader();
        const base64File = await new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file3d);
        });
        templateParams.attachment = {
          name: file3d.name,
          data: base64File,
          mimeType: 'application/octet-stream'
        };
      } catch (error) {
        debugMsg.innerText = "Errore nella lettura del file STL.";
        emailStatus.innerText = "";
        return;
      }
    }

    try {
      await emailjs.send("service_ian3dlab", "emailPreventivo", templateParams);
      emailStatus.innerText = "Email inviata con successo!";
      document.getElementById("preventivoForm").reset();
      document.getElementById("outputPrezzo").innerText = "-";
      debugMsg.innerText = "";
    } catch (error) {
      console.error("Errore nell'invio:", error);
      emailStatus.innerText = "Errore nell'invio: " + (error.text || "Si è verificato un errore.");
    }
  });
</script>

</body>
</html>
