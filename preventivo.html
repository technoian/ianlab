<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preventivo Stampa 3D</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .section {
      margin-bottom: 20px;
    }

    .material-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .material-select {
      width: 200px;
    }

    .material-quantita {
      width: 60px;
    }
  </style>
</head>

<body>
  <h2>Preventivo Stampa 3D</h2>

  <div class="section">
    <label for="fileSTL">File STL:</label>
    <input type="file" id="fileSTL" accept=".stl">
  </div>

  <div class="section">
    <label for="projectLink">oppure Link progetto MakerWorld:</label>
    <input type="url" id="projectLink" placeholder="https://...">
  </div>

  <div class="section">
    <div class="material-row">
      <select name="materiale" class="material-select" id="materiale">
        <option value="PLA">PLA (€20/kg)</option>
        <option value="ABS">ABS (€25/kg)</option>
        <option value="PETG">PETG (€22/kg)</option>
        <option value="TPU">TPU (€30/kg)</option>
      </select>
      <input type="number" min="1" max="100" value="100" class="material-quantita" id="materialQuantita"> <span>%</span>
    </div>
  </div>

  <div class="section">
    <label for="ugello">Ugello:</label>
    <select id="ugello">
      <option value="0.2">0.2mm</option>
      <option value="0.4" selected>0.4mm</option>
      <option value="0.6">0.6mm</option>
      <option value="0.8">0.8mm</option>
    </select>
  </div>

  <div class="section">
    <label for="velocita">Velocità:</label>
    <select id="velocita">
      <option value="50">50 mm/s</option>
      <option value="60" selected>60 mm/s</option>
      <option value="70">70 mm/s</option>
    </select>
  </div>

  <div class="section">
    <label for="quantita">Quantità:</label>
    <input type="number" id="quantita" value="1" min="1">
  </div>

  <div class="section">
    <label for="projectNote">Note progetto:</label><br>
    <textarea id="projectNote" rows="4" cols="50"></textarea>
  </div>

  <div class="section">
    <label for="emailCliente">Tua email:</label>
    <input type="email" id="emailCliente" required>
  </div>

  <button onclick="calcolaPreventivo()">Calcola Preventivo</button>

  <div class="section">
    <p><strong>Risultato:</strong> <span id="risultato">-</span></p>
  </div>

  <div class="section">
    <p id="emailStatus"></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    emailjs.init("YOUR_USER_ID_HERE");

    function calcolaPreventivo() {
      const materiale = document.getElementById("materiale").value;
      const quantita = document.getElementById("quantita").value;
      const ugello = document.getElementById("ugello").value;
      const velocita = document.getElementById("velocita").value;
      const projectNote = document.getElementById("projectNote").value.trim();
      const projectLink = document.getElementById("projectLink").value.trim();
      const emailCliente = document.getElementById("emailCliente").value.trim();
      const fileInput = document.getElementById("fileSTL");

      if (!emailCliente || !emailCliente.includes("@")) {
        alert("Inserisci un'email valida.");
        return;
      }

      const prezzo = (quantita * 5).toFixed(2);
      document.getElementById("risultato").textContent = `€ ${prezzo}`;

      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function (e) {
          const base64File = e.target.result.split(",")[1];

          inviaEmail({
            materiale: materiale,
            ugello: ugello,
            velocita: velocita,
            projectQuantity: quantita,
            projectNote: projectNote,
            projectLink: projectLink,
            emailCliente: emailCliente,
            attachment: base64File
          });
        };

        reader.readAsDataURL(file);
      } else {
        inviaEmail({
          materiale: materiale,
          ugello: ugello,
          velocita: velocita,
          projectQuantity: quantita,
          projectNote: projectNote,
          projectLink: projectLink,
          emailCliente: emailCliente
        });
      }
    }

    function inviaEmail(templateParams) {
      emailjs.send("default_service", "template_ID", templateParams)
        .then(() => {
          document.getElementById("emailStatus").textContent = "Email inviata con successo!";
          document.getElementById("risultato").textContent = "-";
          document.getElementById("fileSTL").value = "";
          document.getElementById("projectLink").value = "";
          document.getElementById("materiale").selectedIndex = 0;
          document.getElementById("materialQuantita").value = 100;
          document.getElementById("ugello").selectedIndex = 1;
          document.getElementById("velocita").selectedIndex = 1;
          document.getElementById("quantita").value = 1;
          document.getElementById("projectNote").value = "";
          document.getElementById("emailCliente").value = "";
        })
        .catch((error) => {
          console.error("Errore invio email:", error);
          document.getElementById("emailStatus").textContent = "Errore nell'invio dell'email.";
        });
    }
  </script>
</body>

</html>
