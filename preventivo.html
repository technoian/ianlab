<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Preventivo Stampa 3D - Materiali con disponibilità</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #viewer {
    width: 500px; height: 500px;
    background: #eee;
    border: 2px dashed #ccc;
    display: flex; align-items: center; justify-content: center;
    color: #666;
    user-select: none;
    margin-bottom: 20px;
    position: relative;
  }
  #viewer.dragover { border-color: #333; background: #ddd; color: #000; }
  #controls { max-width: 400px; margin-bottom: 20px; }
  label { font-weight: bold; margin-top: 10px; display: block; }
  select, input, button { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
  #info { margin-top: 15px; background: #fafafa; padding: 10px; border: 1px solid #ddd; min-height: 60px; }
  #result { margin-top: 10px; padding: 10px; background: #e0ffe0; display: none; font-weight: bold; }
  #message {
    position: fixed;
    top: 10px; left: 50%;
    transform: translateX(-50%);
    background: #ff6666;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    font-weight: bold;
    display: none;
    z-index: 1000;
  }
  option.not-available {
    color: #999;
  }
</style>
</head>
<body>

<div id="controls">
  <button id="btn-upload">Carica file STL</button>
  <input type="file" id="file-input" accept=".stl" style="display:none" />

  <label for="sel-material">Materiale</label>
  <select id="sel-material"></select>

  <label for="sel-nozzle">Ugello (mm)</label>
  <select id="sel-nozzle">
    <option value="0.4">0.4</option>
    <option value="0.6">0.6</option>
    <option value="0.8">0.8</option>
  </select>

  <label for="inp-speed">Velocità (mm/s)</label>
  <input type="number" id="inp-speed" min="10" max="200" value="50" />

  <label for="inp-infill">Riempimento (%)</label>
  <input type="number" id="inp-infill" min="0" max="100" value="20" />

  <button id="btn-calc" style="margin-top:15px;">Calcola Preventivo</button>
</div>

<div id="viewer">Trascina qui il file STL o usa il bottone sopra.</div>
<div id="info"><strong>Dimensioni modello:</strong><br>Larghezza: –<br>Altezza: –<br>Profondità: –</div>
<div id="result"></div>
<div id="message">Materiale non disponibile</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/examples/js/loaders/STLLoader.js"></script>

<script>
  const materiali = [
    { name: "PLA", available: true, price: 0.02 },
    { name: "PLA+ / Tough PLA", available: false, price: 0.025 },
    { name: "PLA Silk / Wood / Marble / Metal", available: false, price: 0.03 },
    { name: "PETG", available: false, price: 0.03 },
    { name: "PETG-CF", available: true, price: 0.04 },
    { name: "TPU 95A", available: true, price: 0.04 },
    { name: "ABS", available: false, price: 0.025 },
    { name: "ASA", available: false, price: 0.035 },
    { name: "PA (Nylon)", available: false, price: 0.05 },
    { name: "PA-CF / PA-GF", available: false, price: 0.055 },
    { name: "PC / PC-Blend", available: false, price: 0.07 },
    { name: "PVA", available: false, price: 0.06 },
    { name: "BVOH", available: false, price: 0.06 }
  ];

  const selMaterial = document.getElementById('sel-material');
  const message = document.getElementById('message');
  let pesoStimato = 0;

  function popolaMateriali() {
    selMaterial.innerHTML = '';
    materiali.forEach((mat, idx) => {
      const option = document.createElement('option');
      option.value = idx;
      const disponibile = mat.available || pesoStimato > 500;
      option.textContent = mat.name + (disponibile ? " ✅" : " ❌");
      option.disabled = !disponibile;
      if (!disponibile) {
        option.classList.add('not-available');
      } else {
        option.classList.remove('not-available');
      }
      selMaterial.appendChild(option);
    });
    let firstAvailableIndex = materiali.findIndex(m => m.available);
    if (firstAvailableIndex >= 0) selMaterial.value = firstAvailableIndex;
    else selMaterial.selectedIndex = 0;
  }

  function showMessage(text) {
    message.textContent = text;
    message.style.display = 'block';
    setTimeout(() => {
      message.style.display = 'none';
    }, 2000);
  }

  selMaterial.addEventListener('change', () => {
    const idx = parseInt(selMaterial.value);
    if (isNaN(idx)) return;
    const mat = materiali[idx];
    const disponibile = mat.available || pesoStimato > 500;
    if (!disponibile) {
      showMessage("Materiale non disponibile");
    }
  });

  const viewer = document.getElementById('viewer');
  const btnUpload = document.getElementById('btn-upload');
  const fileInput = document.getElementById('file-input');
  const info = document.getElementById('info');
  const result = document.getElementById('result');
  const nozzleSel = document.getElementById('sel-nozzle');
  const speedInput = document.getElementById('inp-speed');
  const infillInput = document.getElementById('inp-infill');
  const btnCalc = document.getElementById('btn-calc');

  let scene, camera, renderer, controls;
  let currentObject = null;

  initThree();
  popolaMateriali();

  function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(60, 1, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(500, 500);
    viewer.innerHTML = '';
    viewer.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    camera.position.set(0, 0, 100);
    controls.update();

    scene.add(new THREE.AmbientLight(0x404040));
    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(1, 1, 1).normalize();
    scene.add(dirLight);

    animate();
  }

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }

  function clearScene() {
    if (currentObject) {
      scene.remove(currentObject);
      currentObject.traverse(child => {
        if (child.isMesh) {
          child.geometry.dispose();
          child.material.dispose();
        }
      });
      currentObject = null;
      info.innerHTML = "<strong>Dimensioni modello:</strong><br>Larghezza: –<br>Altezza: –<br>Profondità: –";
      result.style.display = "none";
      result.innerText = "";
      pesoStimato = 0;
      popolaMateriali();
    }
  }

  function adjustCameraAndShowInfo(object) {
    const box = new THREE.Box3().setFromObject(object);
    const size = new THREE.Vector3();
    box.getSize(size);

    info.innerHTML = `<strong>Dimensioni modello:</strong><br>
                      Larghezza: ${size.x.toFixed(2)} mm<br>
                      Altezza: ${size.y.toFixed(2)} mm<br>
                      Profondità: ${size.z.toFixed(2)} mm`;

    const infill = parseFloat(infillInput.value) / 100;
    const volumeCm3 = (size.x * size.y * size.z) * 0.001;
    pesoStimato = volumeCm3 * 1.25 * infill;

    popolaMateriali();

    const maxDim = Math.max(size.x, size.y, size.z);
    const fov = camera.fov * (Math.PI / 180);
    let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
    cameraZ *= 1.5;
    camera.position.set(0, 0, cameraZ);

    const center = box.getCenter(new THREE.Vector3());
    controls.target.copy(center);
    controls.update();
  }

  function loadFile(file) {
    clearScene();

    const filename = file.name.toLowerCase();
    if (!filename.endsWith('.stl')) {
      alert('Puoi caricare solo file STL');
      return;
    }

    const reader = new FileReader();
    reader.onload = e => {
      try {
        const loader = new THREE.STLLoader();
        const geometry = loader.parse(e.target.result);
        const material = new THREE.MeshStandardMaterial({ color: 0x6699ff });
        const mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);
        currentObject = mesh;
        adjustCameraAndShowInfo(mesh);
      } catch(err) {
        alert('Errore nel caricamento STL: ' + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  btnUpload.addEventListener('click', () => {
    fileInput.click();
  });

  fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
      loadFile(fileInput.files[0]);
    }
  });

  viewer.addEventListener('dragover', e => {
    e.preventDefault();
    viewer.classList.add('dragover');
  });
  viewer.addEventListener('dragleave', e => {
    e.preventDefault();
    viewer.classList.remove('dragover');
  });
  viewer.addEventListener('drop', e => {
    e.preventDefault();
    viewer.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
      loadFile(e.dataTransfer.files[0]);
    }
  });

  btnCalc.addEventListener('click', () => {
    if (!currentObject) {
      alert("Carica un modello STL prima di calcolare il preventivo.");
      return;
    }

    const matIdx = parseInt(selMaterial.value);
    if (isNaN(matIdx)) {
      alert("Seleziona un materiale valido.");
      return;
    }
    const mat = materiali[matIdx];
    const disponibile = mat.available || pesoStimato > 500;
    if (!disponibile) {
      showMessage("Materiale non disponibile");
      return;
    }

    const nozzle = parseFloat(nozzleSel.value);
    const speed = parseFloat(speedInput.value);
    const infill = parseFloat(infillInput.value) / 100;

    const box = new THREE.Box3().setFromObject(currentObject);
    const size = new THREE.Vector3();
    box.getSize(size);
    const volumeMm3 = size.x * size.y * size.z;
    const tempoMinuti = (volumeMm3 * 10) / speed;
    const prezzo = pesoStimato * mat.price;

    result.style.display = "block";
    result.innerHTML = `
      <strong>Preventivo:</strong><br>
      Tempo stimato: ${tempoMinuti.toFixed(1)} minuti<br>
      Prezzo stimato: € ${prezzo.toFixed(2)}<br>
     
