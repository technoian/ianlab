<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preventivo Stampa 3D - W OLE MILAN</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0; }
  header, footer { background:#005f73; color:white; padding:10px 20px; text-align:center; }
  main { padding:20px; max-width:600px; margin:auto; }
  #formPreventivo { background:white; padding:15px; border-radius:8px; box-shadow:0 0 8px rgba(0,0,0,0.1); }
  label { display:block; margin-top:15px; font-weight:bold; }
  select, input[type="number"], input[type="text"], input[type="email"], textarea, button {
    width:100%; padding:6px; margin-top:5px; box-sizing:border-box;
  }
  textarea { resize:vertical; min-height:60px; }
  .material-row { display:flex; align-items:center; gap:8px; }
  .material-select { flex:3; }
  .material-quantita { flex:1; }
  .custom-file-button {
    display:inline-block; padding:6px 12px; background:#0a9396; color:white;
    border:none; border-radius:5px; cursor:pointer; font-size:16px; margin-top:5px;
  }
  .custom-file-button:hover { background:#007f7f; }
  #risultato { margin-top:20px; background:#e9ecef; padding:10px; border-radius:5px; min-height:40px; }
  #emailStatus { margin-top:10px; font-weight:bold; }
</style>
</head>
<body>

<header>
  <h1>Preventivo Stampa 3D - W OLE INTER</h1>
</header>

<main>
<section id="formPreventivo">
  <form id="preventivoForm" onsubmit="return false;">
    <!-- Parametri utente mantenuti -->
    <label>Materiale e percentuale(%):</label>
    <div class="material-row">
      <select name="materiale" class="material-select">
        <option value="PLA">PLA (€20/kg)</option>
        <option value="ABS">ABS (€25/kg)</option>
        <option value="PETG">PETG (€22/kg)</option>
        <option value="TPU">TPU (€30/kg)</option>
      </select>
      <input type="number" min="1" max="100" value="100" class="material-quantita"> <span>%</span>
    </div>

    <label for="ugello">Ugello:</label>
    <select id="ugello" name="ugello">
      <option value="0.2">0.2 mm</option>
      <option value="0.4" selected>0.4 mm</option>
      <option value="0.6">0.6 mm</option>
      <option value="0.8">0.8 mm</option>
    </select>

    <label for="velocita">Velocità:</label>
    <select id="velocita" name="velocita">
      <option value="0.5">50%</option>
      <option value="1" selected>100%</option>
      <option value="1.24">124%</option>
      <option value="1.6">160%</option>
    </select>

    <label for="quantita">Quantità (copie):</label>
    <input type="number" id="quantita" value="1" min="1">

    <label for="projectNote">Nota:</label>
    <textarea id="projectNote" placeholder="Aggiungi una nota..."></textarea>

    <label>Caricamento progetto:</label>
    <input type="file" id="file3d" accept=".stl" style="display:none;">
    <button type="button" class="custom-file-button" id="btnCaricaFile">Scegli File STL</button>

    <label for="projectLink">Oppure link progetto Makerworld:</label>
    <input type="text" id="projectLink" placeholder="Inserisci il link del progetto...">

    <button id="btnCalcola">Calcola preventivo</button>

    <div id="risultato">Risultato preventivo: <span id="outputPrezzo">-</span></div>

    <label for="emailCliente">Email</label>
    <input type="email" id="emailCliente" placeholder="Inserire la propria email...">

    <button id="sendEmailBtn" type="button">Invia file su Firebase</button>
    <div id="emailStatus"></div>
  </form>
</section>
</main>

<footer>
  <h1>Progetti Multimateriale e Multicolore</h1>
</footer>

<!-- Firebase SDK -->
<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-storage.js";

  // Configura il tuo progetto Firebase
  const firebaseConfig = {
  apiKey: "AIzaSyDxtlixYrN6bP8l82n7qXdvuEzAH6iUvEo",
  authDomain: "ianlab-3dservices.firebaseapp.com",
  projectId: "ianlab-3dservices",
  storageBucket: "ianlab-3dservices.firebasestorage.app",
  messagingSenderId: "635234682907",
  appId: "1:635234682907:web:af7ed7e76755d1ec71d0be"
  };
  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);

  // Bottone Scegli file
  const fileInput = document.getElementById("file3d");
  document.getElementById("btnCaricaFile").addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", () => {
    if(fileInput.files.length>0) alert("File selezionato: "+fileInput.files[0].name);
  });

  // Bottone Invio file
  document.getElementById("sendEmailBtn").addEventListener("click", () => {
    if(fileInput.files.length === 0) {
      alert("Seleziona prima un file STL!");
      return;
    }

    const file = fileInput.files[0];
    if(file.size > 50*1024*1024) { // 50 MB
      alert("Il file supera 50MB.");
      return;
    }

    const storageRef = ref(storage, 'uploads/'+file.name);
    const uploadTask = uploadBytesResumable(storageRef, file);

    document.getElementById("emailStatus").innerText = "Upload in corso...";

    uploadTask.on('state_changed', 
      (snapshot) => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        document.getElementById("emailStatus").innerText = "Upload "+Math.round(progress)+"% completato...";
      },
      (error) => {
        console.error(error);
        document.getElementById("emailStatus").innerText = "Errore durante l'upload!";
      },
      () => {
        getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
          console.log("File disponibile su:", downloadURL);
          document.getElementById("emailStatus").innerText = "Upload completato! File disponibile su Firebase.";
        });
      }
    );
  });
</script>

</body>
</html>
