<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDxtlixYrN6bP8l82n7qXdvuEzAH6iUvEo",
  authDomain: "ianlab-3dservices.firebaseapp.com",
  projectId: "ianlab-3dservices",
  storageBucket: "ianlab-3dservices.appspot.com",
  messagingSenderId: "635234682907",
  appId: "1:635234682907:web:af7ed7e76755d1ec71d0be"
};
firebase.initializeApp(firebaseConfig);

const storage = firebase.storage();
const auth = firebase.auth();

// âœ… Autenticazione anonima per permettere upload
auth.signInAnonymously().catch(error => {
  console.error("Auth error:", error);
});

const fileInput = document.getElementById("file3d");
const btnCaricaFile = document.getElementById("btnCaricaFile");
const fileNameDisplay = document.getElementById("fileNameDisplay");

btnCaricaFile.addEventListener("click", () => fileInput.click());
fileInput.addEventListener("change", () => {
  if(fileInput.files.length > 0){
    fileNameDisplay.innerText = fileInput.files[0].name;
  } else {
    fileNameDisplay.innerText = "Nessun file selezionato";
  }
});

document.getElementById("sendFileBtn").addEventListener("click", async () => {
  const emailStatus = document.getElementById("emailStatus");
  emailStatus.style.color = "red";
  emailStatus.innerText = "";

  const nomeCliente = document.getElementById("nomeCliente").value.trim();
  const emailCliente = document.getElementById("emailCliente").value.trim();
  const materiale = document.querySelector(".material-select").value;
  const ugello = document.getElementById("ugello").value;
  const velocita = document.getElementById("velocita").value;
  const projectQuantity = document.getElementById("quantita").value;
  const projectNote = document.getElementById("projectNote").value.trim();
  const projectLink = document.getElementById("projectLink").value.trim();
  const file = fileInput.files[0];

  if (!emailCliente || !nomeCliente) {
    emailStatus.innerText = "Nome e email sono obbligatori.";
    return;
  }
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if(!emailRegex.test(emailCliente)){
    emailStatus.innerText = "Formato email non valido.";
    return;
  }

  let filePath = "";
  if(file){
    try {
      const storageRef = storage.ref('uploads/' + file.name);
      const uploadTask = storageRef.put(file);

      await new Promise((resolve, reject) => {
        uploadTask.on('state_changed', snapshot => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          emailStatus.innerText = "Caricamento in corso: " + progress.toFixed(0) + "%";
        }, error => {
          emailStatus.innerText = "Errore caricamento file: " + error.message;
          reject(error);
        }, () => {
          filePath = 'uploads/' + file.name;
          emailStatus.style.color = "green";
          emailStatus.innerText = "File caricato con successo!";
          resolve();
        });
      });
    } catch(err) {
      emailStatus.innerText = "Errore upload: " + err.message;
      return;
    }
  }

  // Invio dati al backend
  try {
    const response = await fetch("https://europe-west1-ianlab-3dservices.cloudfunctions.net/sendPreventivoEmail", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        nomeCliente,
        emailCliente,
        materiale,
        ugello,
        velocita,
        projectQuantity,
        projectNote,
        projectLink,
        filePath
      })
    });

    const result = await response.json();
    if(result.success){
      emailStatus.style.color = "green";
      emailStatus.innerText = "Preventivo inviato con successo!";
    } else {
      emailStatus.style.color = "red";
      emailStatus.innerText = "Errore invio preventivo: " + result.error;
    }
  } catch(err){
    emailStatus.style.color = "red";
    emailStatus.innerText = "Errore invio preventivo: " + err.message;
  }
});
</script>
