<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Preventivo Stampa 3D - Solo Calcolo</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f0f0; }
  header { background: #005f73; color: white; padding: 10px 20px; text-align: center; }
  main { padding: 20px; max-width: 600px; margin: auto; }
  #formPreventivo {
    background: white; 
    padding: 15px; 
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }
  label { display: block; margin-top: 15px; font-weight: bold; }
  select, input[type="number"], input[type="file"] {
    width: 100%;
    padding: 6px;
    margin-top: 5px;
  }
  button {
    margin-top: 20px;
    padding: 10px;
    width: 100%;
    background: #0a9396;
    border: none;
    color: white;
    font-weight: bold;
    cursor: pointer;
    border-radius: 5px;
  }
  button:hover { background: #007f7f; }
  #risultato {
    margin-top: 20px;
    background: #e9ecef;
    padding: 10px;
    border-radius: 5px;
    min-height: 40px;
  }
  .material-row {
    display: flex;
    gap: 10px;
    margin-top: 8px;
    align-items: center;
  }
  .material-row > * {
    flex: 1;
  }
  #aggiungiMateriale {
    margin-top: 10px;
    background: #94d2bd;
    color: #005f73;
    font-weight: normal;
  }
  .material-row button {
    flex: 0 0 30px;
    background: #e63946;
    border: none;
    color: white;
    font-weight: bold;
    cursor: pointer;
    border-radius: 3px;
    font-size: 16px;
    line-height: 1;
  }
</style>
</head>
<body>

<header>
  <h1>Preventivo Stampa 3D - Solo Calcolo</h1>
</header>

<main>
  <section id="formPreventivo">
    <form id="preventivoForm" onsubmit="return false;">
      
      <label>Materiali e percentuali (aggiungi più materiali):</label>
      <div id="materialiContainer">
        <div class="material-row">
          <select name="materiale" class="material-select">
            <option value="PLA">PLA (€20/kg)</option>
            <option value="ABS">ABS (€25/kg)</option>
            <option value="PETG">PETG (€22/kg)</option>
            <option value="TPU">TPU (€30/kg)</option>
          </select>
          <input type="number" min="1" max="100" value="100" class="material-quantita" /> %
          <button type="button" onclick="rimuoviMateriale(this)">✖</button>
        </div>
      </div>
      <button id="aggiungiMateriale" type="button">+ Aggiungi materiale</button>
      
      <label for="ugello">Ugello:</label>
      <select id="ugello" name="ugello">
        <option value="0.2">0.2 mm</option>
        <option value="0.4" selected>0.4 mm</option>
        <option value="0.6">0.6 mm</option>
        <option value="0.8">0.8 mm</option>
      </select>
      
      <label for="velocita">Velocità:</label>
      <select id="velocita" name="velocita">
        <option value="0.5">50%</option>
        <option value="1" selected>100%</option>
        <option value="1.24">124%</option>
        <option value="1.6">160%</option>
      </select>
      
      <label for="file3d">File STL (solo STL):</label>
      <input type="file" id="file3d" accept=".stl" />
      
      <button id="btnCalcola">Calcola preventivo</button>
      
      <div id="risultato">Risultato preventivo: <span id="outputPrezzo">-</span></div>
    </form>
  </section>
</main>

<!-- Libreria Three.js e STLLoader per leggere STL (senza visualizzazione) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/STLLoader.min.js"></script>

<script>
  let geometry = null;

  document.getElementById('file3d').addEventListener('change', function() {
    const file = this.files[0];
    if (!file) {
      geometry = null;
      return;
    }
    if (!file.name.toLowerCase().endsWith('.stl')) {
      alert('Carica solo file STL.');
      this.value = '';
      geometry = null;
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const loader = new THREE.STLLoader();
        geometry = loader.parse(e.target.result);
      } catch (err) {
        alert('Errore nel caricamento STL.');
        geometry = null;
      }
    };
    reader.readAsArrayBuffer(file);
  });

  document.getElementById('aggiungiMateriale').addEventListener('click', () => {
    const container = document.getElementById('materialiContainer');
    const div = document.createElement('div');
    div.className = 'material-row';
    div.innerHTML = `
      <select name="materiale" class="material-select">
        <option value="PLA">PLA (€20/kg)</option>
        <option value="ABS">ABS (€25/kg)</option>
        <option value="PETG">PETG (€22/kg)</option>
        <option value="TPU">TPU (€30/kg)</option>
      </select>
      <input type="number" min="1" max="100" value="100" class="material-quantita" /> %
      <button type="button" onclick="rimuoviMateriale(this)">✖</button>
    `;
    container.appendChild(div);
  });

  function rimuoviMateriale(btn) {
    const container = document.getElementById('materialiContainer');
    if (container.children.length > 1) {
      btn.parentNode.remove();
    } else {
      alert('Deve esserci almeno un materiale.');
    }
  }

  document.getElementById('btnCalcola').addEventListener('click', () => {
    if (!geometry) {
      alert('Devi caricare un file STL prima di calcolare.');
      return;
    }

    const materiali = document.querySelectorAll('.material-row');
    let totalePercent = 0;
    let prezzoMateriali = 0;
    const prezziPerKg = { PLA: 20, ABS: 25, PETG: 22, TPU: 30 };

    materiali.forEach(row => {
      const mat = row.querySelector('.material-select').value;
      const perc = parseFloat(row.querySelector('.material-quantita').value);
      if (perc > 0) {
        totalePercent += perc;
        prezzoMateriali += (prezziPerKg[mat] || 20) * (perc / 100);
      }
    });

    if (totalePercent > 100) {
      alert('La somma delle percentuali materiali non può superare 100%.');
      return;
    }
    if (totalePercent === 0) {
      alert('Devi specificare almeno un materiale con percentuale > 0.');
      return;
    }

    const ugello = parseFloat(document.getElementById('ugello').value);
    const velocita = parseFloat(document.getElementById('velocita').value);

    geometry.computeBoundingBox();
    const bbox = geometry.boundingBox;
    const size = new THREE.Vector3();
    bbox.getSize(size);

    // volume approssimativo bounding box in cm^3 (assumendo mm di STL)
    const volumeCm3 = (size.x / 10) * (size.y / 10) * (size.z / 10);
    const densita = 1.25; // g/cm3 PLA

    let pesoKg = (volumeCm3 * densita) / 1000; // kg

    if (pesoKg < 0.01) pesoKg = 0.01;

    let prezzoBase = prezzoMateriali *
