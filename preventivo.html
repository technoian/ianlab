<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Preventivo Stampa 3D - Solo STL</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #viewer {
    width: 500px; height: 500px;
    background: #eee;
    border: 2px dashed #ccc;
    display: flex; align-items: center; justify-content: center;
    color: #666;
    user-select: none;
    margin-bottom: 20px;
    position: relative;
  }
  #viewer.dragover { border-color: #333; background: #ddd; color: #000; }
  #controls { max-width: 400px; margin-bottom: 20px; }
  label { font-weight: bold; margin-top: 10px; display: block; }
  input, select, button { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
  #info { margin-top: 15px; background: #fafafa; padding: 10px; border: 1px solid #ddd; min-height: 60px; }
  #result { margin-top: 10px; padding: 10px; background: #e0ffe0; display: none; font-weight: bold; }
  #msg {
    position: fixed;
    top: 20px; left: 50%;
    transform: translateX(-50%);
    background: #f44336; /* rosso */
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    display: none;
    font-weight: bold;
    z-index: 1000;
  }
  #materials-list {
    margin-top: 5px;
    font-size: 14px;
    max-height: 120px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 5px;
  }
  #materials-list span {
    cursor: pointer;
    user-select: none;
    margin-right: 8px;
    padding: 3px 5px;
    border-radius: 3px;
    display: inline-block;
  }
  #materials-list span.available {
    color: green;
  }
  #materials-list span.unavailable {
    color: red;
  }
  #materials-list span.selected {
    background: #6699ff;
    color: white;
  }
</style>
</head>
<body>

<div id="controls">
  <button id="btn-upload">Carica file STL</button>
  <input type="file" id="file-input" accept=".stl" style="display:none" />

  <label>Materiale</label>
  <div id="materials-list"></div>

  <label>Ugello (mm)</label>
  <select id="sel-nozzle">
    <option value="0.4">0.4</option>
    <option value="0.6">0.6</option>
    <option value="0.8">0.8</option>
  </select>

  <label>Velocità (mm/s)</label>
  <input type="number" id="inp-speed" min="10" max="200" value="50" />

  <label>Riempimento (%)</label>
  <input type="number" id="inp-infill" min="0" max="100" value="20" />

  <button id="btn-calc" style="margin-top:15px;">Calcola Preventivo</button>
</div>

<div id="viewer">Trascina qui il file STL o usa il bottone sopra.</div>
<div id="info"><strong>Dimensioni modello:</strong><br>Larghezza: –<br>Altezza: –<br>Profondità: –</div>
<div id="result"></div>

<div id="msg">Materiale non disponibile</div>

<!-- three.js e STLLoader -->
<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/examples/js/loaders/STLLoader.js"></script>

<script>
  const viewer = document.getElementById('viewer');
  const btnUpload = document.getElementById('btn-upload');
  const fileInput = document.getElementById('file-input');
  const btnCalc = document.getElementById('btn-calc');
  const info = document.getElementById('info');
  const result = document.getElementById('result');
  const nozzleSel = document.getElementById('sel-nozzle');
  const speedInput = document.getElementById('inp-speed');
  const infillInput = document.getElementById('inp-infill');
  const materialsList = document.getElementById('materials-list');
  const msg = document.getElementById('msg');

  let currentObject = null;
  let scene, camera, renderer, controls;
  let currentColor = 0x6699ff;
  let selectedMaterial = null;
  let pesoStimato = 0;

  // Lista materiali (nome, prezzo €/g, disponibile?)
  const materiali = [
    {name: "PLA", price: 0.02, available: true},
    {name: "ABS", price: 0.025, available: true},
    {name: "PETG", price: 0.03, available: false},
    {name: "Nylon", price: 0.05, available: false},
    {name: "TPU", price: 0.04, available: true},
    {name: "Resina", price: 0.1, available: false},
    {name: "PC", price: 0.07, available: false},
    {name: "ASA", price: 0.035, available: true}
  ];

  function initMaterialsList() {
    materialsList.innerHTML = '';
    materiali.forEach((mat, i) => {
      const span = document.createElement('span');
      span.textContent = mat.name + ' ' + (mat.available ? '✅' : '❌');
      span.classList.add(mat.available ? 'available' : 'unavailable');
      span.dataset.index = i;
      if (i === 0) {
        span.classList.add('selected');
        selectedMaterial = materiali[0];
      }
      span.addEventListener('click', onMaterialClick);
      materialsList.appendChild(span);
    });
  }

  function showMsg(text) {
    msg.textContent = text;
    msg.style.display = 'block';
    setTimeout(() => {
      msg.style.display = 'none';
    }, 2000);
  }

  function onMaterialClick(e) {
    const idx = parseInt(e.currentTarget.dataset.index);
    const mat = materiali[idx];
    if (!mat.available && pesoStimato <= 500) {
      showMsg("Materiale non disponibile");
      return;
    }
    // Deseleziona tutti
    [...materialsList.children].forEach(c => c.classList.remove('selected'));
    // Seleziona il cliccato
    e.currentTarget.classList.add('selected');
    selectedMaterial = mat;
  }

  function init() {
    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(60, 1, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(500, 500);
    viewer.innerHTML = '';
    viewer.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    camera.position.set(0, 0, 100);
    controls.update();

    scene.add(new THREE.AmbientLight(0x404040));
    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(1, 1, 1).normalize();
    scene.add(dirLight);

    animate();
    initMaterialsList();
  }

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }

  function clearScene() {
    if (currentObject) {
      scene.remove(currentObject);
      currentObject.traverse(child => {
        if (child.isMesh) {
          child.geometry.dispose();
          child.material.dispose();
        }
      });
      currentObject = null;
      info.innerHTML = "<strong>Dimensioni modello:</strong><br>Larghezza: –<br>Altezza: –<br>Profondità: –";
      result.style.display = "none";
      result.innerText = "";
      pesoStimato = 0;
    }
  }

  function adjustCamera(object) {
    const box = new THREE.Box3().setFromObject(object);
    const size = new THREE.Vector3();
    box.getSize(size);

    info.innerHTML = `<strong>Dimensioni modello:</strong><br>
                      Larghezza: ${size.x.toFixed(2)} mm<br>
                      Altezza: ${size.y.toFixed(2)} mm<br>
                      Profondità: ${size.z.toFixed(2)} mm`;

    const maxDim = Math.max(size.x, size.y, size.z);
    const fov = camera.fov * (Math.PI / 180);
    let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
    cameraZ *= 1.5;
    camera.position.set(0, 0, cameraZ);

    const center = box.getCenter(new THREE.Vector3());
    controls.target.copy(center);
    controls.update();
  }

  function loadFile(file) {
    clearScene();

    const filename = file.name.toLowerCase();
    if (!filename.endsWith('.stl')) {
      alert('Puoi caricare solo file STL');
      return;
    }

    const reader = new FileReader();
    reader.onload = e => {
      try {
        const loader = new THREE.STLLoader();
        const geometry = loader.parse(e.target.result);
        const material = new THREE.MeshStandardMaterial({ color: currentColor });
        const mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);
        currentObject = mesh;
        adjustCamera(mesh);
      } catch(err) {
        alert('Errore nel caricamento STL: ' + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  viewer.addEventListener('dragover', e => {
    e.preventDefault();
    viewer.classList.add('dragover');
  });

  viewer.addEventListener('dragleave', e => {
    e.preventDefault();
    viewer.classList.remove('dragover');
  });

  viewer.addEventListener('drop', e => {
    e.preventDefault();
    viewer.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
      loadFile(e.dataTransfer.files[0]);
    }
  });

  btnUpload.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', e => {
    if (fileInput.files.length > 0) {
      loadFile(fileInput.files[0]);
    }
  });

  btnCalc.addEventListener('click', () => {
    if (!currentObject) {
      alert("Carica prima un file STL.");
      return;
    }
    const box = new THREE.Box3().setFromObject(currentObject);
    const size = new THREE.Vector3();
    box.getSize(size);

    const volumeMM3 = size.x * size.y * size.z;
    const densitaPLA = 1.24; // g/cm³ per PLA, usata come riferimento per peso
    let peso = (volumeMM3 / 1000) * densitaPLA; // grammi stimati

    let infill = parseFloat(infillInput.value);
    if (isNaN(infill) || infill < 0 || infill > 100) infill = 20;
    peso = peso * (infill / 100);

    pesoStimato = peso;

    // Controllo disponibilità materiale anche se ❌ se peso > 500g
    if (!selectedMaterial.available && peso > 500) {
      // Considerato disponibile
    } else if (!selectedMaterial.available && peso <= 500) {
      showMsg("Materiale non disponibile");
      result.style.display = "none";
      return;
    }

    const prezzoGrammo = selectedMaterial.price;

    const costoMateriale = peso * prezzoGrammo;

    const velocita = parseFloat(speedInput.value);
    const tempoOre = (volumeMM3 / 100000) / (velocita / 60);

    const prezzoFinale = costoMateriale + tempoOre * 5;

    result.style.display = "block";
    result.innerHTML = `
      Peso stimato: ${peso.toFixed(2)} g<br>
      Tempo stimato: ${tempoOre.toFixed(2)} ore<br>
      Costo materiale: €${costoMateriale.toFixed(2)}<br>
      Prezzo finale stimato: <strong>€${prezzoFinale.toFixed(2)}</strong>
    `;
  });

  init();
</script>

</body>
</html>
